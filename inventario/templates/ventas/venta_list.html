{% extends 'base.html' %}

{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Ventas</h3>
    <a class="btn btn-primary" href="{% url 'ventas:venta_create' %}"><i class="fas fa-plus"></i> Nueva venta</a>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <form class="row g-2 align-items-end" method="get">
        <div class="col-sm-3">
          <label class="form-label small text-muted">Desde</label>
          <input type="text" name="desde" class="form-control" placeholder="dd/mm/aaaa" value="{{ filter_desde }}">
        </div>
        <div class="col-sm-3">
          <label class="form-label small text-muted">Hasta</label>
          <input type="text" name="hasta" class="form-control" placeholder="dd/mm/aaaa" value="{{ filter_hasta }}">
        </div>
        <div class="col-sm-4">
          <label class="form-label small text-muted">Cliente</label>
          <input list="clientes_list" name="cliente" class="form-control" placeholder="Cliente" value="{{ filter_cliente }}">
          <datalist id="clientes_list">
            {% for c in clientes %}
            <option value="{{ c.pk }} - {{ c }}"></option>
            {% endfor %}
          </datalist>
        </div>
        <div class="col-sm-2 text-end">
          <button type="submit" class="btn btn-secondary">Filtrar</button>
          <a href="{% url 'ventas:venta_list' %}" class="btn btn-link">Limpiar</a>
        </div>
      </form>
    </div>
  </div>

  <div class="list-group">
    {% for venta in ventas %}
    <a href="{% url 'ventas:venta_detail' venta.pk %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-bold">{{ venta.codigo }}</div>
        <div class="small text-muted">{{ venta.cliente }} · {{ venta.fecha|date:"Y-m-d H:i" }}</div>
      </div>
      <div class="text-end">
        <div class="h6 mb-1 text-primary">${{ venta.total }}</div>
        <small class="text-muted">Ver detalles <i class="fas fa-arrow-right"></i></small>
      </div>
    </a>
    {% empty %}
    <div class="list-group-item">No hay ventas.</div>
    {% endfor %}
  </div>

  <div class="card mt-4">
    <div class="card-body">
      <h5 class="card-title">Ventas por producto</h5>
      <div style="height:300px; max-height:420px;">
        <canvas id="ventasChart" style="width:100%; height:100%;"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script>
    (function(){
      const ctx = document.getElementById('ventasChart');
      if(!ctx) return;

      // build url to fetch totals per product, preserve current filters
      const params = new URLSearchParams(window.location.search);
      const url = '{% url "ventas:ventas_por_producto" %}' + (params.toString() ? ('?' + params.toString()) : '');

      fetch(url)
        .then(r => r.json())
        .then(data => {
          const labels = data.map(d => d.product);
          const values = data.map(d => Number(d.total));

          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Ventas (USD)',
                data: values,
                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { display: true, title: { display: false } },
                y: { display: true, title: { display: true, text: 'Total' }, beginAtZero: true }
              },
              plugins: { legend: { display: false } }
            }
          });
        })
        .catch(err => console.error('Error cargando datos de ventas:', err));
    })();
  </script>

  {% if is_paginated %}
    <nav aria-label="Paginación" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">&laquo;</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
        {% endif %}

        {% for num in paginator.page_range %}
          {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% elif num > page_obj.number|add:'-5' and num < page_obj.number|add:'5' %}
            <li class="page-item"><a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">&raquo;</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

</div>
{% endblock %}
