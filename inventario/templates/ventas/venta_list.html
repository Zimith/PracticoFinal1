{% extends 'base.html' %}

{% block content %}
<div class="container">
  <h1>Ventas</h1>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-primary" href="{% url 'ventas:venta_create' %}">Nueva venta</a>
    <form class="form-inline" method="get">
      <div class="form-row align-items-center">
        <div class="col-auto">
          <input type="text" name="desde" class="form-control mb-2" placeholder="Desde dd/mm/aaaa" value="{{ filter_desde }}">
        </div>
        <div class="col-auto">
          <input type="text" name="hasta" class="form-control mb-2" placeholder="Hasta dd/mm/aaaa" value="{{ filter_hasta }}">
        </div>
        <div class="col-auto">
          <input list="clientes_list" name="cliente" class="form-control mb-2" placeholder="Cliente (escribir o seleccionar)" value="{{ filter_cliente }}">
          <datalist id="clientes_list">
            {% for c in clientes %}
            <option value="{{ c.pk }} - {{ c }}"></option>
            {% endfor %}
          </datalist>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-secondary mb-2">Filtrar</button>
          <a href="{% url 'ventas:venta_list' %}" class="btn btn-link mb-2">Limpiar</a>
        </div>
      </div>
    </form>
  </div>
  <script>
    // Auto-insert slashes for date inputs (dd/mm/yyyy)
    function setupDateMask(selector) {
      const el = document.querySelector(selector);
      if (!el) return;
      el.addEventListener('input', function(e) {
        let v = el.value.replace(/[^0-9]/g, '').slice(0,8);
        if (v.length >= 3 && v[2] !== '/') v = v.slice(0,2) + '/' + v.slice(2);
        if (v.length >= 6 && v[5] !== '/') v = v.slice(0,5) + '/' + v.slice(5);
        el.value = v;
      });
    }
    document.addEventListener('DOMContentLoaded', function() {
      setupDateMask('input[name="desde"]');
      setupDateMask('input[name="hasta"]');
    });
  </script>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>CÃ³digo</th>
        <th>Cliente</th>
        <th>Fecha</th>
        <th>Total</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for venta in ventas %}
      <tr>
        <td>{{ venta.codigo }}</td>
        <td>{{ venta.cliente }}</td>
        <td>{{ venta.fecha }}</td>
        <td>{{ venta.total }}</td>
        <td>
          <a href="{% url 'ventas:venta_detail' venta.pk %}" class="btn btn-info btn-sm" title="Ver"><i class="fas fa-eye"></i></a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5">No hay ventas.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% if is_paginated %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">&laquo;</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
      {% endif %}

      {% for num in paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num > page_obj.number|add:'-5' and num < page_obj.number|add:'5' %}
          <li class="page-item"><a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ num }}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">&raquo;</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
      {% endif %}
    </ul>
  </nav>
{% endif %}
{% endblock %}
