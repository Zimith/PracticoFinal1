{% extends 'base.html' %}

{% load crispy_forms_tags %}

{% block content %}
<div class="container">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="fas fa-cash-register"></i> Nueva venta</h4>
      <a href="{% url 'ventas:venta_list' %}" class="btn btn-outline-secondary btn-sm">Volver</a>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <div class="row">
          <div class="col-md-5">
            {{ venta_form|crispy }}
          </div>
          <div class="col-md-7">
            <h5>Items</h5>
            <div class="table-responsive">
              <table class="table table-sm" id="items-table">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Precio unitario</th>
                    <th>Cantidad</th>
                    <th>Eliminar</th>
                  </tr>
                </thead>
                <tbody>
                  {{ formset.management_form }}
                  {% for form in formset.forms %}
                  <tr>
                    <td>{{ form.producto }}</td>
                    <td><span class="precio" data-form-index="{{ forloop.counter0 }}">-</span></td>
                    <td>{{ form.cantidad }}</td>
                    <td>{{ form.DELETE }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-end mt-3">
          <button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Confirmar venta</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  // product prices mapping provided by view
  const PRODUCT_PRICES = {{ product_prices_json|safe }};

  function updatePrices() {
    // for each product select in the formset, update the corresponding .precio span
    document.querySelectorAll('select[name$="-producto"]').forEach(function(sel, idx) {
      const formIndex = sel.name.split('-')[0];
      const priceSpan = document.querySelector('.precio[data-form-index="' + idx + '"]');
      if (!priceSpan) return;
      const val = sel.value;
      if (val && PRODUCT_PRICES[val] !== undefined) {
        priceSpan.textContent = PRODUCT_PRICES[val];
      } else {
        priceSpan.textContent = '-';
      }
    });
  }

  document.addEventListener('change', function(e) {
    if (e.target && e.target.matches('select[name$="-producto"]')) {
      updatePrices();
    }
  });

  // initial fill
  document.addEventListener('DOMContentLoaded', function() { updatePrices(); });
</script>
{% endblock %}
